##################################################################
# This file is automatically generated when running "manala up". #
##################################################################

version: '3.8'

{{- $has_traefik := .Vars.system.traefik.version -}}
{{- $has_mysql := .Vars.system.mysql.version -}}
{{- $has_redis := .Vars.system.redis.version -}}

{{- $network_name := cat .Vars.system.app_name "-network" -}}

services:
{{- if $has_traefik }}
  traefik:
    image: traefik:v2.5
    command: --api.insecure=true --providers.docker
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - {{ $network_name }}
{{- end }}

  {{ .Vars.system.app_name }}:
    container_name: {{ .Vars.system.app_name }}
    build:
        context: ./docker/php/local
        dockerfile: Dockerfile
        args:
            WWWGROUP: '${WWWGROUP}'
    image: sail-7.4/app
    labels:
      - "traefik.http.routers.{{ .Vars.system.app_name }}.rule=Host(`noshow.local`) {{- if .Vars.system.routing_rules!=null }} && PathPrefix(`{{ .Vars.system.routing_rules }}`) {{- end}}"
    extra_hosts:
        - 'host.docker.internal:host-gateway'
    ports:
      - "80"
    environment:
      WWWUSER: '${WWWUSER}'
      LARAVEL_SAIL: 1
      XDEBUG_MODE: '${SAIL_XDEBUG_MODE:-off}'
      XDEBUG_CONFIG: '${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}'
    volumes:
      - '.:/var/www/html'
    networks:
        - {{ $network_name }}
    {{- if or $has_mysql $has_redis }}
    depends_on:
        {{- if $has_mysql }}- {{ .Vars.system.app_name }}-mysql {{- end }}
        {{- if $has_redis }}- {{ .Vars.system.app_name }}-redis {{- end }}
  {{- end }}

{{- if $has_mysql -}}
{{- $mariadb := .Vars.system.mysql }}
  {{ .Vars.system.app_name }}-mysql:
    image: 'mysql:{{ $mariadb.version }}'
    container_name: {{ .Vars.system.app_name }}-mysql
    cap_add:
      - SYS_NICE
    ports:
      - "${FORWARD_DB_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: '${DB_PASSWORD}'
      MYSQL_DATABASE: '${DB_DATABASE}'
      MYSQL_USER: '${DB_USERNAME}'
      MYSQL_PASSWORD: '${DB_PASSWORD}'
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      TZ: {{ .Vars.system.timezone }}
    networks:
      - {{ $network_name }}
    volumes:
      - db-data:/var/lib/mysql
      - .manala/init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: mysqladmin ping --silent
      timeout: 5s
      retries: 5
{{- end }}

{{- if $has_redis }}
  redis:
    image: 'redis:alpine'
    container_name: {{ .Vars.system.app_name }}-mysql
    ports:
      - "${FORWARD_REDIS_PORT:-6379}:6379"
    environment:
      TZ: {{ .Vars.system.timezone }}
    networks:
      - {{ $network_name }}
    volumes:
      - {{ .Vars.system.app_name }}-redis-data:/data
	healthcheck:
      test: redis-cli ping
      retries: 3
      timeout: 5s
{{- end }}

networks:
{{- if .Vars.system.is_main_project }}
    {{ $network_name }}:
        driver: bridge
{{ else }}
	{{ $network_name }}:
		external:
			name: noshow-main_noshow-main-network
{{ end }}

{{ if or ($has_mysql) ($has_redis) }}
volumes:
    {{ if ($has_mysql) -}}
    {{ .Vars.system.app_name }}-mysql-data:
        driver: local
    {{- end }}
    {{ if $has_redis -}}
    {{ .Vars.system.app_name }}-redis-data:
    {{- end }}
{{- end }}
