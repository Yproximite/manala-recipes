##################################################################
# This file is automatically generated when running "manala up". #
##################################################################

version: "3.9"

volumes:
    db-data:
    redis-data:
    elastic-data:
    minio-data:

services:
  database:
    image: 'mysql:{{ .Vars.system.mysql.version }}'
    ports: [3306]
    environment:
      MYSQL_USER: 'app'
      MYSQL_PASSWORD: 'app'
      MYSQL_DATABASE: 'app'
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - db-data:/var/lib/mysql
      - .manala/init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: mysqladmin ping --silent
      interval: 10s
      timeout: 5s
      retries: 5

  phpmyadmin:
    image: phpmyadmin
    ports: [80]
    environment:
      PMA_HOST: 'database'
      PMA_USER: 'app'
      PMA_PASSWORD: 'app'

  redis:
    image: 'redis:alpine'
    ports: [6379]
    environment:
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - redis-data:/data

  phpredisadmin:
    image: erikdubbelboer/phpredisadmin
    ports: [80]
    environment:
      REDIS_1_HOST: 'redis'

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:{{ .Vars.system.elasticsearch.version }}
    {{- if .Vars.system.elasticsearch.plugins }}
    entrypoint: /init-elasticsearch/entrypoint.sh
    {{- end }}
    environment:
      - node.name=elasticsearch
      - cluster.name=es-docker-cluster
      {{- if ne .Vars.system.elasticsearch.version "6.8.22" }}
      - cluster.initial_master_nodes=elasticsearch
      {{- end }}
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elastic-data:/usr/share/elasticsearch/data
      {{- if .Vars.system.elasticsearch.plugins }}
      - ./.manala/init-elasticsearch:/init-elasticsearch
      {{- end }}
    ports: [9200]

  kibana:
    image: docker.elastic.co/kibana/kibana:{{ .Vars.system.elasticsearch.version }}
    ports: [5601]
    environment:
      ELASTICSEARCH_URL: http://${ES_CONTAINER}:9200
      ELASTICSEARCH_HOSTS: '["http://${ES_CONTAINER}:9200"]'

  minio:
    image: quay.io/minio/minio
    labels:
      com.symfony.server.service-prefix: 'MINIO'
    ports: [ "9000","9001" ]
    environment:
      MINIO_ROOT_USER: 'access_app'
      MINIO_ROOT_PASSWORD: 'secret_app'
    volumes:
      - minio-data:/data
    command:
      - server
      - /data
      - --console-address
      - "0.0.0.0:9001"
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 5s
      timeout: 5s
      retries: 5

  createbuckets:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set local http://minio:9000 access_app secret_app;
      /usr/bin/mc mb local/syl-{{ .Vars.system.app_name }};
      /usr/bin/mc anonymous set public local/syl-{{ .Vars.system.app_name }};
      exit 0;
      "
