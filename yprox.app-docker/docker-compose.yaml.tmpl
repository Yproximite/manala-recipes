##################################################################
# This file is automatically generated when running "manala up". #
##################################################################

{{- $has_postgresql := .Vars.system.postgresql.version -}}
{{- $has_mariadb := .Vars.system.mariadb.version -}}
{{- $has_mysql := .Vars.system.mysql.version -}}
{{- $has_redis := .Vars.system.redis.version -}}
{{- $has_mailpit := .Vars.system.mailpit.version -}}
{{- $has_mongo := .Vars.system.mongo.version -}}
{{- $has_elastic := .Vars.system.elasticsearch.version -}}

{{- if or ($has_postgresql) ($has_mariadb) ($has_mysql) ($has_redis) ($has_mongo) ($has_elastic) }}

volumes:
    {{- if or ($has_postgresql) ($has_mariadb) ($has_mysql) }}
    db-data:
    {{- end }}
    {{- if $has_redis }}
    redis-data:
    {{- end }}
    {{- if $has_mailpit }}
    mailpit-data:
    {{- end }}
    {{- if $has_mongo }}
    mongo-data:
    {{- end }}
    {{- if $has_elastic }}
    elastic-data:
    {{- end }}
{{- end }}

services:
{{- if $has_postgresql -}}
{{- $postgresql := .Vars.system.postgresql }}

  database:
    image: 'postgres:{{ $postgresql.version }}-alpine'
    ports: [5432]
    environment:
      POSTGRES_USER: 'app'
      POSTGRES_PASSWORD: 'app'
      POSTGRES_DB: 'app'
      TZ: {{ .Vars.system.timezone }}
      PGTZ: {{ .Vars.system.timezone }}
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: pg_isready
      interval: 10s
      timeout: 5s
      retries: 5

  phppgadmin:
    image: bitnami/phppgadmin
    ports: [8080]
    environment:
      DATABASE_HOST: 'database'

{{- end }}

{{- if $has_mariadb -}}
{{- $mariadb := .Vars.system.mariadb }}

  database:
    image: 'mariadb:{{ $mariadb.version }}'
    ports: [3306]
    environment:
      MYSQL_USER: 'app'
      MYSQL_PASSWORD: 'app'
      MYSQL_DATABASE: 'app'
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - db-data:/var/lib/mysql
      - .manala/init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: mysqladmin ping --silent
      interval: 10s
      timeout: 5s
      retries: 5

{{- end }}

{{- if $has_mysql -}}
{{- $mysql := .Vars.system.mysql }}

  database:
    image: 'mysql:{{ $mysql.version }}'
    ports: [3306]
    environment:
      MYSQL_USER: 'app'
      MYSQL_PASSWORD: 'app'
      MYSQL_DATABASE: 'app'
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - db-data:/var/lib/mysql
      - .manala/init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: mysqladmin ping --silent
      interval: 10s
      timeout: 5s
      retries: 5

{{- end }}

{{- if or ($has_mariadb) ($has_mysql) }}

  phpmyadmin:
    image: phpmyadmin
    ports: [80]
    environment:
      PMA_HOST: 'database'
      PMA_USER: 'app'
      PMA_PASSWORD: 'app'

{{- end }}

{{- if $has_redis }}

  redis:
    image: 'redis:alpine'
    ports: [6379]
    environment:
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - redis-data:/data

  phpredisadmin:
    image: erikdubbelboer/phpredisadmin
    ports: [80]
    environment:
      REDIS_1_HOST: 'redis'

{{- end }}

{{- if $has_mailpit }}

  mailpit:
    image: axllent/mailpit
    ports:
      - 1025
      - 8025
    environment:
      MP_MAX_MESSAGES: 5000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    volumes:
      - mailpit-data:/data

{{- end }}

{{- if $has_mongo }}
{{- $mongo := .Vars.system.mongo }}

  mongo:
    image: 'mongo:{{ $mongo.version }}-stretch'
    ports: [27017]
    environment:
      MONGO_INITDB_DATABASE: 'app'
      MONGO_INITDB_ROOT_USERNAME: 'app'
      MONGO_INITDB_ROOT_PASSWORD: 'app'
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - mongo-data:/data/db

{{- end }}

{{- if $has_elastic }}
{{- $elastic := .Vars.system.elasticsearch }}
{{- $has_plugins := .Vars.system.elasticsearch.plugins }}

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:{{ $elastic.version }}
    {{- if $has_plugins }}
    entrypoint: /init-elasticsearch/entrypoint.sh
    {{- end }}
    environment:
      - node.name=elasticsearch
      - cluster.name=es-docker-cluster
      - cluster.initial_master_nodes=elasticsearch
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - elastic-data:/usr/share/elasticsearch/data
      {{- if $has_plugins }}
      - ./.manala/init-elasticsearch:/init-elasticsearch
      {{- end }}
    ports: [9200]

  kibana:
    image: docker.elastic.co/kibana/kibana:{{ $elastic.version }}
    ports: [5601]
    environment:
      ELASTICSEARCH_URL: http://${ES_CONTAINER}:9200
      ELASTICSEARCH_HOSTS: '["http://${ES_CONTAINER}:9200"]'

{{- end }}
