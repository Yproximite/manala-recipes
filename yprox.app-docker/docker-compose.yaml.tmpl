##################################################################
# This file is automatically generated when running "manala up". #
##################################################################

version: '3.6'

{{- $has_postgresql := .Vars.system.postgresql.version -}}
{{- $has_mariadb := .Vars.system.mariadb.version -}}
{{- $has_redis := .Vars.system.redis.version -}}

{{ if or ($has_postgresql) ($has_mariadb) ($has_redis) }}

volumes:
    {{ if or ($has_postgresql) ($has_mariadb) -}}
    db-data:
    {{- end }}
    {{ if $has_redis -}}
    redis-data:
    {{- end }}
{{- end }}

services:
{{- if $has_postgresql -}}
{{- $postgresql := .Vars.system.postgresql }}

  database:
    image: 'postgres:{{ $postgresql.version }}-alpine'
    ports: [5432]
    environment:
      POSTGRES_USER: 'app'
      POSTGRES_PASSWORD: 'app'
      POSTGRES_DB: 'app'
      TZ: {{ .Vars.system.timezone }}
      PGTZ: {{ .Vars.system.timezone }}
    volumes:
      - db-data:/var/lib/postgresql/data
{{- end }}

{{- if $has_mariadb -}}
{{- $mariadb := .Vars.system.mariadb }}

  database:
    image: 'mariadb:{{ $mariadb.version }}-alpine'
    ports: [3306]
    environment:
      MYSQL_USER: 'app'
      MYSQL_PASSWORD: 'app'
      MYSQL_DATABASE: 'app'
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - db-data:/var/lib/mysql
{{- end }}

{{- if $has_redis }}

  redis:
    image: 'redis:alpine'
    ports: [6379]
    environment:
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - redis-data:/data
{{- end }}
