##################################################################
# This file is automatically generated when running "manala up". #
##################################################################

version: "3.9"

services:
  wordpress-{{ .Vars.system.app_name }}-web:
    build:
      context: .
      dockerfile: .docker/Dockerfile
      target: development
      args:
        PHP_INI_OPCACHE_ENABLE: 0
    container_name: wordpress-{{ .Vars.system.app_name }}-web
    labels:
      - "ycli.host={{ .Vars.system.app_name }}.wordpress.vm"
      - "traefik.http.routers.wordpress-{{ .Vars.system.app_name }}.rule=Host(`{{ .Vars.system.app_name }}.wordpress.vm`)"
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - "8080"
    env_file:
      - .env
    environment:
      TZ: Etc/UTC
      PORT: 8080
    volumes:
      - ./:/var/www/html
      - ${HOME}/.composer/auth.json:/root/.composer/auth.json:ro
    networks:
      - wordpress-network
    depends_on:
      wordpress-{{ .Vars.system.app_name }}-database:
        condition: service_healthy

  wordpress-{{ .Vars.system.app_name }}-database:
    image: mysql:5.7
    container_name: wordpress-{{ .Vars.system.app_name }}-database
    ports:
      - "3306"
    volumes:
      - wordpress-{{ .Vars.system.app_name }}-database-data:/var/lib/mysql
    networks:
      - wordpress-network
    environment:
      TZ: {{ .Vars.system.timezone }}
    env_file:
      - .env
    healthcheck:
      test: mysqladmin ping --silent
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  wordpress-{{ .Vars.system.app_name }}-database-data:

networks:
  wordpress-network:
    external: true
